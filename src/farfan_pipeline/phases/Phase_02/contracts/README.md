# Phase 2 Contracts

**PHASE_LABEL: Phase 2**

## Overview

This directory contains the formal contracts that define Phase 2 behavior, ensuring deterministic execution and seamless integration with Phase 1 and Phase 3.

## Contract Files

### 1. Input Contract (`phase2_input_contract.py`)

Validates that Phase 2 receives valid input from Phase 1.

**Preconditions**:
- `PRE-001`: Valid CanonPolicyPackage from Phase 1
- `PRE-002`: Exactly 60 chunks
- `PRE-003`: Schema version CPP-2025.1
- `PRE-004`: Valid Phase 1 compatibility certificate
- `PRE-005`: 300 questions in questionnaire
- `PRE-006`: 240 methods in registry

**Usage**:
```python
from farfan_pipeline.phases.Phase_02.contracts import (
    Phase2InputValidator,
    verify_phase2_input_contract
)

# Validate all inputs
is_valid = verify_phase2_input_contract(
    cpp=canon_policy_package,
    certificate=phase1_cert,
    questionnaire=questionnaire,
    registry=method_registry
)
```

### 2. Mission Contract (`phase2_mission_contract.py`)

Defines the execution flow and topological order of all Phase 2 modules.

**Key Features**:
- 42 modules in deterministic order
- 9 execution stages
- DAG acyclicity verification
- Complete dependency mapping

**Execution Stages**:
1. `INFRASTRUCTURE` - Package init and constants
2. `FACTORY` - DI factory and registries
3. `REGISTRY` - Validation and setup
4. `RESOURCE_MANAGEMENT` - Resource monitoring
5. `SYNCHRONIZATION` - Chunk-executor sync
6. `TASK_EXECUTION` - Task orchestration
7. `CONTRACT_EXECUTION` - 300 contract execution
8. `EVIDENCE_ASSEMBLY` - Evidence graph construction
9. `NARRATIVE_SYNTHESIS` - Doctoral carver
10. `PROFILING` - Metrics and calibration

**Usage**:
```python
from farfan_pipeline.phases.Phase_02.contracts import (
    verify_phase2_mission_contract,
    get_topological_sort,
    verify_dag_acyclicity
)

# Verify mission contract
verify_phase2_mission_contract()

# Get module execution order
modules = get_topological_sort()

# Check for circular dependencies
is_acyclic = verify_dag_acyclicity()
```

### 3. Output Contract (`phase2_output_contract.py`)

Validates that Phase 2 produces complete output compatible with Phase 3.

**Postconditions**:
- `POST-001`: 300 complete results
- `POST-002`: Coverage of all 60 chunks
- `POST-003`: Structured evidence in all results
- `POST-004`: Narrative synthesis (min 100 chars)
- `POST-005`: Confidence scores in [0, 1]
- `POST-006`: Complete provenance with SHA-256
- `POST-007`: Schema version Phase2Result-2025.1
- `POST-008`: Phase 3 compatibility certificate

**Usage**:
```python
from farfan_pipeline.phases.Phase_02.contracts import (
    Phase2Output,
    Phase2OutputValidator,
    generate_phase3_compatibility_certificate,
    verify_phase2_output_contract
)

# Create output package
output = Phase2Output(
    results=list_of_results,
    execution_metadata=metadata
)

# Validate output
is_valid = verify_phase2_output_contract(output)

# Generate Phase 3 certificate
certificate = generate_phase3_compatibility_certificate(output)
print(f"Status: {certificate.status}")
print(f"Hash: {certificate.output_hash}")
```

## Compatibility Certificates

### Phase 1 → Phase 2 Certificate

Required fields:
```json
{
  "status": "VALID",
  "phase": 1,
  "timestamp": "2026-01-13T...",
  "cpp_hash": "sha256:...",
  "chunk_count": 60
}
```

### Phase 2 → Phase 3 Certificate

Generated by output contract:
```json
{
  "status": "VALID",
  "phase": 2,
  "timestamp": "2026-01-13T...",
  "total_results": 300,
  "valid_results": 300,
  "chunks_covered": 60,
  "output_hash": "sha256:...",
  "certificate_version": "CERT-P2-2025.1"
}
```

## Testing

All contracts have comprehensive unit tests in `../tests/test_phase2_contracts.py`.

Run tests:
```bash
PYTHONPATH=src python3 -m pytest \
  src/farfan_pipeline/phases/Phase_02/tests/test_phase2_contracts.py -v
```

Expected output:
```
============================== 20 passed in 0.16s ==============================
```

## Verification Commands

### Quick Verification
```bash
# Verify all contracts at once
python3 -c "
import sys; sys.path.insert(0, 'src')

# Input contract
from farfan_pipeline.phases.Phase_02.contracts import Phase2InputPreconditions
print('Input preconditions:', Phase2InputPreconditions())

# Mission contract  
from farfan_pipeline.phases.Phase_02.contracts import verify_phase2_mission_contract
verify_phase2_mission_contract()

# Output contract
from farfan_pipeline.phases.Phase_02.contracts import Phase2OutputPostconditions
print('Output postconditions:', Phase2OutputPostconditions())
"
```

### Individual Contract Verification
```python
# Input Contract
from farfan_pipeline.phases.Phase_02.contracts import verify_phase2_input_contract
try:
    verify_phase2_input_contract(cpp, cert, questionnaire, registry)
    print("✓ Input contract satisfied")
except Exception as e:
    print(f"✗ Input contract failed: {e}")

# Mission Contract
from farfan_pipeline.phases.Phase_02.contracts import verify_phase2_mission_contract
result = verify_phase2_mission_contract()
print(f"✓ Mission contract verified: DAG is acyclic")

# Output Contract
from farfan_pipeline.phases.Phase_02.contracts import verify_phase2_output_contract
try:
    verify_phase2_output_contract(output)
    print("✓ Output contract satisfied")
except Exception as e:
    print(f"✗ Output contract failed: {e}")
```

## Integration with CI/CD

### Pre-execution Checks
```yaml
- name: Verify Phase 2 Input Contract
  run: |
    python scripts/verify_phase2_input.py --strict
```

### Post-execution Checks
```yaml
- name: Verify Phase 2 Output Contract
  run: |
    python scripts/verify_phase2_output.py --strict --generate-certificate
```

### DAG Integrity
```yaml
- name: Verify Phase 2 DAG
  run: |
    python scripts/audit/verify_phase_chain.py --phase 2 --strict
```

## Architecture Notes

Phase 2 uses a **300-contract architecture**:
- 30 base questions (Q001-Q030)
- 10 policy areas (PA01-PA10)
- 300 individual contracts (30 × 10)

**Not** the legacy 30-executor design (D1Q1-D6Q5).

Each contract specifies:
- Question identity and policy area
- Method binding from 240-method dispensary
- Evidence assembly rules
- Output synthesis requirements

## Version History

- **1.0.0** (2026-01-13): Initial contracts created
  - Input contract with 6 preconditions
  - Mission contract with 42 modules
  - Output contract with 8 postconditions
  - 20 comprehensive tests (all passing)

## References

- Phase 2 README: `../README.md`
- Audit Report: `../docs/AUDIT_REPORT.md`
- Test Suite: `../tests/test_phase2_contracts.py`
- Method Registry: `../phase2_10_02_methods_registry.py`

---

**Contract Version**: 1.0.0  
**Last Updated**: 2026-01-13  
**Status**: ✅ ACTIVE
