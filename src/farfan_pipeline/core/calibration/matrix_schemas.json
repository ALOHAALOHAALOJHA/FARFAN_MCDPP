{
  "specification_metadata": {
    "title": "PDT Matrix Schemas Specification",
    "version": "1.0.0",
    "description": "Defines schemas for indicator matrices and PPI matrices with field requirements, validation rules, temporal validity, and accounting closure constraints",
    "created": "2024",
    "based_on": "canonic_description_unit_analysis.json, pdt_structure.py, and unit_layer.py",
    "scope": "Matrix-level validation for I (Indicator Quality) and P (PPI Completeness) components of Unit Layer evaluation"
  },
  "indicator_matrix_schema": {
    "description": "Schema for Matriz de Indicadores (Indicator Matrix) that links strategic planning with product and result measurement",
    "table_names": [
      "Matriz de Indicadores",
      "Matriz de indicadores",
      "Plan de Indicadores",
      "Indicadores de Producto",
      "Indicadores de Resultado"
    ],
    "critical_fields": {
      "Tipo": {
        "label": "Tipo de indicador",
        "description": "Type of indicator (Product or Result)",
        "data_type": "string",
        "required": true,
        "allowed_values": [
          "PRODUCTO",
          "RESULTADO",
          "Producto",
          "Resultado",
          "META DE PRODUCTO",
          "META DE RESULTADO"
        ],
        "validation": {
          "not_empty": true,
          "no_placeholders": true
        }
      },
      "Línea Estratégica": {
        "label": "Línea Estratégica",
        "description": "Strategic line to which the indicator belongs",
        "data_type": "string",
        "required": true,
        "validation": {
          "not_empty": true,
          "no_placeholders": true,
          "min_length": 5,
          "must_link_to": "strategic_lines_in_parte_estrategica"
        }
      },
      "Programa": {
        "label": "Programa presupuestal",
        "description": "Budget program name",
        "data_type": "string",
        "required": true,
        "validation": {
          "not_empty": true,
          "no_placeholders": true,
          "min_length": 5,
          "must_link_to": "programs_in_parte_estrategica"
        }
      },
      "Línea Base": {
        "label": "Línea base indicador",
        "description": "Baseline value of the indicator before intervention",
        "data_type": "numeric_or_descriptive",
        "required": true,
        "validation": {
          "not_empty": true,
          "no_placeholders": true,
          "numeric_preferred": true
        }
      },
      "Meta Cuatrienio": {
        "label": "Meta Total cuatrienio 2024-2027",
        "description": "Target value for the 4-year period",
        "data_type": "numeric_or_descriptive",
        "required": true,
        "validation": {
          "not_empty": true,
          "no_placeholders": true,
          "numeric_preferred": true,
          "coherence_check": "must_differ_from_linea_base"
        }
      },
      "Fuente": {
        "label": "Fuente de información",
        "description": "Data source for the indicator",
        "data_type": "string",
        "required": true,
        "validation": {
          "not_empty": true,
          "no_placeholders": true,
          "min_length": 3,
          "expected_sources": [
            "DANE",
            "Municipio",
            "Secretaría",
            "Ministerio",
            "DNP",
            "SISBEN",
            "ADRES",
            "Comisaría de Familia"
          ]
        }
      },
      "Unidad Medida": {
        "label": "Unidad de medida",
        "description": "Unit of measurement for the indicator",
        "data_type": "string",
        "required": true,
        "validation": {
          "not_empty": true,
          "no_placeholders": true,
          "common_units": [
            "Número",
            "Porcentaje",
            "Tasa",
            "Casos",
            "Personas",
            "Documentos",
            "Kilómetros",
            "Unidades"
          ]
        }
      }
    },
    "optional_fields": {
      "Año LB": {
        "label": "Año línea base",
        "description": "Year of the baseline measurement",
        "data_type": "integer",
        "required": false,
        "validation": {
          "temporal_validity": {
            "min_year": 2019,
            "max_year": 2024,
            "rationale": "Baseline must be recent (2019-2024) to be relevant for 2024-2027 planning"
          }
        },
        "weight": 0.5
      },
      "Código MGA": {
        "label": "Código de Producto MGA",
        "description": "Methodologia General Ajustada product code",
        "data_type": "string",
        "required": false,
        "validation": {
          "pattern": "^\\d{7}$",
          "example": "1203009"
        },
        "weight": 0.5
      },
      "Cód. Programa": {
        "label": "Código del Programa Presupuestal",
        "description": "Budget program code",
        "data_type": "string",
        "required": false,
        "validation": {
          "pattern": "^\\d{4}$",
          "example": "1203"
        }
      },
      "Cód. indicador de producto": {
        "label": "Código del Indicador",
        "description": "Indicator code",
        "data_type": "string",
        "required": false
      }
    },
    "placeholder_detection": {
      "description": "Placeholders reduce indicator quality and trigger penalties",
      "placeholder_values": [
        "S/D",
        "N/A",
        "TBD",
        "Por definir",
        "Sin dato",
        "Sin información",
        "",
        null
      ],
      "placeholder_penalty_multiplier": 3.0,
      "rationale": "Placeholders in critical fields indicate incomplete planning and reduce trustworthiness"
    },
    "temporal_validity": {
      "baseline_years": {
        "min": 2019,
        "max": 2024,
        "description": "Baseline measurements must be from 2019-2024 to be relevant for 2024-2027 planning period"
      },
      "target_years": {
        "min": 2024,
        "max": 2027,
        "description": "Targets must fall within the 4-year mandate period (2024-2027)"
      },
      "validation_rules": {
        "baseline_before_target": true,
        "reasonable_time_gap": {
          "min_years": 0,
          "max_years": 8,
          "rationale": "Baseline should not be more than 8 years old"
        }
      }
    },
    "quality_scoring": {
      "I_struct": {
        "description": "Field completeness score",
        "formula": "(critical_present / total_critical) × w_critical + (optional_present / total_optional) × w_optional - placeholder_penalty",
        "critical_weight": 2.0,
        "optional_weight": 1.0,
        "normalization": "(w_critical + w_optional)",
        "hard_gate": {
          "threshold": 0.7,
          "consequence": "If I_struct < 0.7, then I = 0.0"
        }
      },
      "I_link": {
        "description": "Traceability between indicators and strategic lines",
        "formula": "linked_count / total_rows",
        "linking_methods": [
          "fuzzy_string_match",
          "shared_keywords",
          "explicit_codes"
        ],
        "fuzzy_threshold": 0.85,
        "min_shared_words": 2
      },
      "I_logic": {
        "description": "Temporal coherence of baseline and target years",
        "formula": "1.0 - (violations / total_rows)",
        "violations": [
          "baseline_year_out_of_range",
          "target_year_out_of_range",
          "baseline_after_target",
          "invalid_year_format"
        ]
      },
      "I_total": {
        "formula": "w_struct × I_struct + w_link × I_link + w_logic × I_logic",
        "weights": {
          "w_struct": 0.4,
          "w_link": 0.3,
          "w_logic": 0.3
        }
      }
    },
    "example_rows": [
      {
        "context": "Miranda - Conflict Resolution Training",
        "Tipo": "PRODUCTO",
        "Línea Estratégica": "Fortalecimiento de capacidades institucionales",
        "Cód. Programa": "1203",
        "Programa": "Promoción de los métodos de resolución de conflictos",
        "Cód. Producto": "1203009",
        "Producto": "Servicio de educación informal en resolución de conflictos",
        "Cód. indicador de producto": "120300900",
        "Indicador": "Personas capacitadas",
        "Unidad de medida": "Número",
        "Línea Base": 12,
        "Año LB": 2023,
        "Fuente": "Municipio Miranda - Secretaria de Gobierno",
        "Meta Cuatrienio": 30
      },
      {
        "context": "El Tambo - Planning Documents",
        "Tipo": "PRODUCTO",
        "Programa": "Desarrollo integral de la primera infancia",
        "Cód. Producto": "4102051",
        "Producto": "Documentos de planeación elaborados",
        "Indicador": "Documentos elaborados",
        "Línea Base": "S/D",
        "Año LB": "S/D",
        "Meta Cuatrienio": 1,
        "quality_note": "Low quality due to S/D placeholders"
      }
    ]
  },
  "ppi_matrix_schema": {
    "description": "Schema for Plan Plurianual de Inversiones (PPI) matrix detailing budget projections and funding sources",
    "table_names": [
      "Plan Plurianual de Inversiones",
      "Matriz PPI",
      "Plan plurianual de inversiones",
      "PPI"
    ],
    "mandatory_columns": {
      "Línea Estratégica": {
        "label": "Línea Estratégica",
        "description": "Strategic line grouping programs",
        "data_type": "string",
        "required": true,
        "validation": {
          "not_empty": true,
          "must_link_to": "strategic_lines_in_parte_estrategica"
        }
      },
      "Programa": {
        "label": "Programa presupuestal",
        "description": "Budget program name",
        "data_type": "string",
        "required": true,
        "validation": {
          "not_empty": true,
          "must_link_to": "programs_in_parte_estrategica"
        }
      },
      "Costo Total": {
        "label": "Costo Total Cuatrienio",
        "description": "Total investment cost for 2024-2027",
        "data_type": "numeric",
        "required": true,
        "validation": {
          "must_be_positive": true,
          "currency": "COP",
          "format": "numeric_or_currency_string"
        }
      }
    },
    "temporal_distribution_columns": {
      "description": "Annual budget distribution across the 4-year period",
      "vigencias": [
        {
          "column": "2024",
          "label": "TOTAL 2024 / Vigencia 2024",
          "year": 2024,
          "data_type": "numeric",
          "required": true
        },
        {
          "column": "2025",
          "label": "TOTAL 2025 / Vigencia 2025",
          "year": 2025,
          "data_type": "numeric",
          "required": true
        },
        {
          "column": "2026",
          "label": "TOTAL 2026 / Vigencia 2026",
          "year": 2026,
          "data_type": "numeric",
          "required": true
        },
        {
          "column": "2027",
          "label": "TOTAL 2027 / Vigencia 2027",
          "year": 2027,
          "data_type": "numeric",
          "required": true
        }
      ],
      "accounting_closure_rule": {
        "formula": "sum(2024, 2025, 2026, 2027) = Costo Total ± tolerance",
        "tolerance": 0.01,
        "tolerance_description": "1% tolerance for rounding errors",
        "violation_penalty": "Consistency score reduced"
      }
    },
    "funding_source_columns": {
      "description": "Breakdown by funding source",
      "sources": [
        {
          "column": "SGP",
          "label": "Sistema General de Participaciones",
          "description": "National transfers for social sectors",
          "data_type": "numeric",
          "required": true
        },
        {
          "column": "SGR",
          "label": "Sistema General de Regalías",
          "description": "Royalties system (requires independent chapter)",
          "data_type": "numeric",
          "required": true
        },
        {
          "column": "Propios",
          "label": "Recursos Propios",
          "description": "Municipal own-source revenues",
          "data_type": "numeric",
          "required": true
        },
        {
          "column": "Otras",
          "label": "Otras Fuentes",
          "description": "Other sources (credits, cooperation, etc.)",
          "data_type": "numeric",
          "required": true
        }
      ],
      "optional_sources": [
        {
          "column": "Créditos",
          "label": "Créditos",
          "description": "Credit financing"
        },
        {
          "column": "Cooperación",
          "label": "Cooperación Internacional",
          "description": "International cooperation"
        },
        {
          "column": "Fondo subregional",
          "label": "Fondo subregional",
          "description": "Regional funds (e.g., Alto Patía)"
        }
      ],
      "accounting_closure_rule": {
        "formula": "sum(SGP, SGR, Propios, Otras, [optional_sources]) = Costo Total ± tolerance",
        "tolerance": 0.01,
        "tolerance_description": "1% tolerance for rounding errors",
        "violation_penalty": "Consistency score reduced"
      }
    },
    "optional_columns": {
      "Sector": {
        "label": "Sector",
        "description": "Investment sector (e.g., Inclusión Social, Educación)",
        "data_type": "string",
        "example": "41 Inclusión Social"
      },
      "Cód. Programa": {
        "label": "Código del Programa",
        "description": "Program code",
        "data_type": "string",
        "example": "4103"
      }
    },
    "validation_rules": {
      "minimum_non_zero_rows": {
        "threshold": 0.80,
        "description": "At least 80% of rows must have non-zero Costo Total",
        "rationale": "Too many zero-cost rows indicate incomplete planning"
      },
      "accounting_closure": {
        "temporal_closure": {
          "check": "sum(vigencias[2024-2027]) ≈ Costo Total",
          "tolerance": "±1%",
          "required": true
        },
        "source_closure": {
          "check": "sum(sources) ≈ Costo Total",
          "tolerance": "±1%",
          "required": true
        },
        "penalties": {
          "per_violation": 0.5,
          "max_violations": "2 per row (temporal + source)"
        }
      },
      "traceability": {
        "strategic_line_linkage": {
          "method": "fuzzy_string_match",
          "threshold": 0.80,
          "description": "Línea Estratégica must match strategic lines in Parte Estratégica"
        },
        "program_linkage": {
          "method": "fuzzy_string_match",
          "threshold": 0.80,
          "description": "Programa must match programs in Parte Estratégica"
        }
      }
    },
    "quality_scoring": {
      "P_presence": {
        "description": "Matrix exists",
        "formula": "1.0 if matrix found, else 0.0",
        "hard_gate": {
          "enforce": true,
          "consequence": "If PPI not present and required, U = 0.0"
        }
      },
      "P_struct": {
        "description": "Proportion of rows with non-zero costs",
        "formula": "nonzero_rows / total_rows",
        "threshold": 0.80,
        "hard_gate": {
          "threshold": 0.7,
          "consequence": "If P_struct < 0.7, penalize heavily"
        }
      },
      "P_consistency": {
        "description": "Accounting closure compliance",
        "formula": "1.0 - (violations / (total_rows × 2))",
        "checks_per_row": 2,
        "check_types": [
          "temporal_sum_closure",
          "source_sum_closure"
        ]
      },
      "P_total": {
        "formula": "w_presence × P_presence + w_struct × P_struct + w_consistency × P_consistency",
        "weights": {
          "w_presence": 0.2,
          "w_struct": 0.4,
          "w_consistency": 0.4
        }
      }
    },
    "example_rows": [
      {
        "context": "Mercaderes - SGR Total for Quadrennium",
        "Costo Total Cuatrienio": 8242757474.0,
        "TOTAL 2024": 822843000.0,
        "TOTAL 2025": 2770002915.0,
        "TOTAL 2026": 1846668610.0,
        "TOTAL 2027": 2803242949.0,
        "temporal_closure": "sum = 8,242,757,474 ✓",
        "quality_note": "Perfect temporal closure"
      },
      {
        "context": "Caloto - Social Inclusion Program 2024 (millions)",
        "Sector": "41 Inclusión Social",
        "Programa": "4103 Tejiendo lazos familiares",
        "TOTAL 2024": 136.551,
        "SGP": 86.769,
        "Regalías": 0,
        "Recursos Propios": 49.782,
        "Otras Fuentes": 0,
        "source_closure": "sum = 136.551 ✓",
        "quality_note": "Perfect source closure"
      }
    ]
  },
  "anti_gaming_detection": {
    "description": "Rules to detect and penalize artificial compliance without substantive content",
    "placeholder_ratio_check": {
      "max_allowed": 0.10,
      "description": "Maximum 10% of fields can be placeholders (S/D, N/A, TBD)",
      "penalty": "0.5 × (placeholder_ratio - max_allowed)",
      "applies_to": "indicator_matrix"
    },
    "unique_values_check": {
      "min_unique_ratio": 0.50,
      "description": "At least 50% of cost values must be unique (prevents copy-paste)",
      "penalty": "0.3 × (min_ratio - actual_ratio)",
      "applies_to": "ppi_matrix"
    },
    "number_density_check": {
      "min_density": 0.02,
      "description": "At least 2% of tokens in critical sections must be numbers",
      "penalty": "0.2 × (min_density - actual_density)",
      "applies_to": [
        "Diagnóstico",
        "Parte Estratégica",
        "PPI"
      ]
    },
    "gaming_penalty_cap": 0.3,
    "rationale": "These checks prevent superficial compliance where forms are filled but content lacks substance"
  },
  "references": {
    "implementation_indicator": "src/farfan_pipeline/core/calibration/unit_layer.py::_compute_indicator_quality",
    "implementation_ppi": "src/farfan_pipeline/core/calibration/unit_layer.py::_compute_ppi_completeness",
    "data_structure": "src/farfan_pipeline/core/calibration/pdt_structure.py::PDTStructure",
    "configuration": "src/farfan_pipeline/core/calibration/config 2.py::UnitLayerConfig",
    "canonical_source": "canonic_description_unit_analysis.json",
    "methodology": "Metodología General Ajustada (MGA) - DNP"
  }
}
