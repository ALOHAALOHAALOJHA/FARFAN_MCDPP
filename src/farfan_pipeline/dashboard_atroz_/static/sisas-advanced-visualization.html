<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISAS Advanced Visualization - ATROZ Dashboard v3.0</title>
    
    <!-- Chart.js for advanced visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- D3.js for flow diagrams -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #1a2332;
            --bg-panel: #2a3544;
            --border-color: #2d3748;
            --text-primary: #e0e6ed;
            --text-secondary: #a0aec0;
            --accent-cyan: #4fc3f7;
            --accent-green: #4caf50;
            --accent-orange: #ff9800;
            --accent-red: #f44336;
            --accent-blue: #2196f3;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .dashboard-container {
            padding: 2rem;
            max-width: 2000px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .status-panel {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .status-badge {
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(76, 175, 80, 0.2);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        /* Metric Cards Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-panel) 100%);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(79, 195, 247, 0.3);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .metric-title {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-icon {
            font-size: 1.5rem;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .metric-trend {
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metric-trend.up {
            color: var(--accent-green);
        }

        .metric-trend.down {
            color: var(--accent-red);
        }

        /* Chart Panels */
        .chart-panel {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-panel) 100%);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .panel-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent-cyan);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .panel-controls {
            display: flex;
            gap: 0.5rem;
        }

        .control-button {
            padding: 0.5rem 1rem;
            background: rgba(79, 195, 247, 0.1);
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: rgba(79, 195, 247, 0.2);
            transform: translateY(-2px);
        }

        .control-button.active {
            background: var(--accent-cyan);
            color: var(--bg-primary);
        }

        .chart-container {
            position: relative;
            height: 350px;
        }

        .chart-container.large {
            height: 450px;
        }

        /* Grid Layouts */
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .three-column {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Flow Diagram Styles */
        .flow-diagram {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 1rem;
            min-height: 400px;
        }

        .flow-node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .flow-node:hover {
            transform: scale(1.05);
        }

        .flow-link {
            fill: none;
            stroke: var(--accent-cyan);
            stroke-width: 2;
            opacity: 0.6;
            animation: flowPulse 3s infinite;
        }

        @keyframes flowPulse {
            0%, 100% { stroke-dasharray: 5, 5; stroke-dashoffset: 0; }
            50% { stroke-dasharray: 5, 5; stroke-dashoffset: 10; }
        }

        /* Gate Matrix */
        .gate-matrix {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .gate-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .gate-card:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-4px);
        }

        .gate-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-cyan);
            margin-bottom: 0.5rem;
        }

        .gate-name {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .gate-percentage {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Consumer List */
        .consumer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .consumer-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 1rem;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .consumer-card.active {
            border-left-color: var(--accent-green);
            background: rgba(76, 175, 80, 0.1);
        }

        .consumer-card.processing {
            border-left-color: var(--accent-orange);
            background: rgba(255, 152, 0, 0.1);
        }

        .consumer-card.waiting {
            border-left-color: var(--accent-blue);
            background: rgba(33, 150, 243, 0.1);
        }

        .consumer-card.error {
            border-left-color: var(--accent-red);
            background: rgba(244, 67, 54, 0.1);
        }

        .consumer-name {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .consumer-stats {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }

        /* Loading Animation */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(79, 195, 247, 0.3);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .two-column {
                grid-template-columns: 1fr;
            }
            
            .three-column {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .gate-matrix {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .three-column {
                grid-template-columns: 1fr;
            }
            
            .gate-matrix {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>üî¨ SISAS Advanced Visualization</h1>
                <div class="header-subtitle">
                    Real-Time Signal Observatory with Advanced Analytics | ATROZ Dashboard v3.0
                </div>
            </div>
            <div class="status-panel">
                <div class="status-badge" id="sisasStatus">
                    <div class="status-indicator"></div>
                    <span>ONLINE</span>
                </div>
                <button class="control-button" onclick="refreshDashboard()">üîÑ Refresh</button>
            </div>
        </div>

        <!-- Real-Time Metrics Grid -->
        <div class="metrics-grid" id="metricsGrid">
            <!-- Dynamically populated -->
        </div>

        <!-- Signal Throughput Time Series -->
        <div class="chart-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <span>üìä</span>
                    Signal Throughput (Real-Time)
                </div>
                <div class="panel-controls">
                    <button class="control-button active" onclick="setTimeRange('1h')">1H</button>
                    <button class="control-button" onclick="setTimeRange('6h')">6H</button>
                    <button class="control-button" onclick="setTimeRange('24h')">24H</button>
                    <button class="control-button" onclick="setTimeRange('7d')">7D</button>
                </div>
            </div>
            <div class="chart-container large">
                <canvas id="throughputChart"></canvas>
            </div>
        </div>

        <!-- Gate Performance & Signal Distribution -->
        <div class="two-column">
            <!-- Gate Success Rates -->
            <div class="chart-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>üö™</span>
                        Gate Success Rates
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="gateSuccessChart"></canvas>
                </div>
            </div>

            <!-- Signal Type Distribution -->
            <div class="chart-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>üéØ</span>
                        Signal Type Distribution
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="signalTypeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Gate Matrix Details -->
        <div class="chart-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <span>üîç</span>
                    4-Gate Validation Matrix
                </div>
            </div>
            <div class="gate-matrix" id="gateMatrix">
                <!-- Dynamically populated -->
            </div>
        </div>

        <!-- Consumer Performance & Signal Latency -->
        <div class="two-column">
            <!-- Consumer Throughput -->
            <div class="chart-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>‚öôÔ∏è</span>
                        Consumer Throughput
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="consumerThroughputChart"></canvas>
                </div>
            </div>

            <!-- Signal Latency Distribution -->
            <div class="chart-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>‚è±Ô∏è</span>
                        Signal Latency Distribution
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="latencyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Signal Flow Diagram -->
        <div class="chart-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <span>üåä</span>
                    Interactive Signal Flow
                </div>
                <div class="panel-controls">
                    <button class="control-button" onclick="resetZoom()">Reset View</button>
                    <button class="control-button" onclick="toggleAnimation()">Toggle Animation</button>
                </div>
            </div>
            <div class="flow-diagram" id="flowDiagram">
                <!-- D3.js flow visualization -->
            </div>
        </div>

        <!-- Consumer Status Grid -->
        <div class="chart-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <span>üéõÔ∏è</span>
                    Consumer Status Grid (17 Consumers)
                </div>
            </div>
            <div class="consumer-grid" id="consumerGrid">
                <!-- Dynamically populated -->
            </div>
        </div>

        <!-- Error Analysis & Dead Letter Queue -->
        <div class="three-column">
            <!-- Error Types -->
            <div class="chart-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>‚ö†Ô∏è</span>
                        Error Types
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="errorTypesChart"></canvas>
                </div>
            </div>

            <!-- Dead Letter Queue Trends -->
            <div class="chart-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>üíÄ</span>
                        DLQ Trends
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="dlqChart"></canvas>
                </div>
            </div>

            <!-- Phase Distribution -->
            <div class="chart-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>üìà</span>
                        Phase Distribution
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="phaseChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Socket.IO for real-time updates -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <script>
        // ============================================================
        // GLOBAL STATE & CONFIGURATION
        // ============================================================
        
        let charts = {};
        let currentTimeRange = '1h';
        let socket;
        let animationEnabled = true;
        
        const config = {
            chartColors: {
                primary: '#4fc3f7',
                success: '#4caf50',
                warning: '#ff9800',
                error: '#f44336',
                info: '#2196f3',
                purple: '#9c27b0',
                cyan: '#00bcd4',
                teal: '#009688'
            },
            updateInterval: 2000, // 2 seconds
            maxDataPoints: 60
        };

        // ============================================================
        // INITIALIZATION
        // ============================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[SISAS Dashboard] Initializing...');
            initializeWebSocket();
            initializeCharts();
            initializeMetrics();
            initializeGateMatrix();
            initializeConsumerGrid();
            initializeFlowDiagram();
            startAutoRefresh();
        });

        // ============================================================
        // WEBSOCKET CONNECTION
        // ============================================================
        
        function initializeWebSocket() {
            socket = io('http://localhost:5000');
            
            socket.on('connect', () => {
                console.log('[SISAS] WebSocket connected');
                updateStatusBadge('online');
            });
            
            socket.on('disconnect', () => {
                console.log('[SISAS] WebSocket disconnected');
                updateStatusBadge('offline');
            });
            
            socket.on('sisas_metrics', (data) => {
                console.log('[SISAS] Received metrics update', data);
                updateDashboardWithMetrics(data);
            });
            
            socket.on('pipeline_progress', (data) => {
                console.log('[SISAS] Pipeline progress update', data);
                updateFlowDiagram(data);
            });
        }

        function updateStatusBadge(status) {
            const badge = document.getElementById('sisasStatus');
            if (status === 'online') {
                badge.innerHTML = '<div class="status-indicator"></div><span>ONLINE</span>';
                badge.style.background = 'rgba(76, 175, 80, 0.2)';
                badge.style.color = '#4caf50';
                badge.style.borderColor = '#4caf50';
            } else {
                badge.innerHTML = '<span>OFFLINE</span>';
                badge.style.background = 'rgba(244, 67, 54, 0.2)';
                badge.style.color = '#f44336';
                badge.style.borderColor = '#f44336';
            }
        }

        // ============================================================
        // METRICS CARDS
        // ============================================================
        
        function initializeMetrics() {
            const metricsData = [
                {
                    title: 'Signals Dispatched',
                    value: '1,247',
                    trend: '+12.5%',
                    trendDirection: 'up',
                    icon: 'üì§'
                },
                {
                    title: 'Signals Delivered',
                    value: '1,183',
                    trend: '+8.3%',
                    trendDirection: 'up',
                    icon: '‚úÖ'
                },
                {
                    title: 'Avg Latency',
                    value: '47ms',
                    trend: '-15.2%',
                    trendDirection: 'up',
                    icon: '‚ö°'
                },
                {
                    title: 'Active Consumers',
                    value: '14/17',
                    trend: '82%',
                    trendDirection: 'up',
                    icon: '‚öôÔ∏è'
                },
                {
                    title: 'Success Rate',
                    value: '94.9%',
                    trend: '+2.1%',
                    trendDirection: 'up',
                    icon: 'üéØ'
                },
                {
                    title: 'Dead Letters',
                    value: '64',
                    trend: '-5.2%',
                    trendDirection: 'up',
                    icon: 'üíÄ'
                }
            ];
            
            renderMetrics(metricsData);
        }

        function renderMetrics(metricsData) {
            const container = document.getElementById('metricsGrid');
            container.innerHTML = metricsData.map(metric => `
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">${metric.title}</div>
                        <div class="metric-icon">${metric.icon}</div>
                    </div>
                    <div class="metric-value">${metric.value}</div>
                    <div class="metric-trend ${metric.trendDirection}">
                        <span>${metric.trendDirection === 'up' ? '‚ñ≤' : '‚ñº'}</span>
                        <span>${metric.trend} from last hour</span>
                    </div>
                </div>
            `).join('');
        }

        // ============================================================
        // CHART INITIALIZATION
        // ============================================================
        
        function initializeCharts() {
            initThroughputChart();
            initGateSuccessChart();
            initSignalTypeChart();
            initConsumerThroughputChart();
            initLatencyChart();
            initErrorTypesChart();
            initDLQChart();
            initPhaseChart();
        }

        function initThroughputChart() {
            const ctx = document.getElementById('throughputChart').getContext('2d');
            
            // Generate mock time-series data
            const now = new Date();
            const labels = [];
            const dispatchedData = [];
            const deliveredData = [];
            
            for (let i = 60; i >= 0; i--) {
                const time = new Date(now - i * 60000); // 1 minute intervals
                labels.push(time);
                dispatchedData.push(Math.floor(Math.random() * 50 + 150));
                deliveredData.push(Math.floor(Math.random() * 45 + 140));
            }
            
            charts.throughput = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Dispatched',
                            data: dispatchedData,
                            borderColor: config.chartColors.primary,
                            backgroundColor: 'rgba(79, 195, 247, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Delivered',
                            data: deliveredData,
                            borderColor: config.chartColors.success,
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#e0e6ed' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 35, 50, 0.95)',
                            titleColor: '#4fc3f7',
                            bodyColor: '#e0e6ed',
                            borderColor: '#2d3748',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                displayFormats: {
                                    minute: 'HH:mm'
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#a0aec0' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#a0aec0' }
                        }
                    }
                }
            });
        }

        function initGateSuccessChart() {
            const ctx = document.getElementById('gateSuccessChart').getContext('2d');
            
            charts.gateSuccess = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Gate 1\nScope', 'Gate 2\nValue', 'Gate 3\nCapability', 'Gate 4\nIrrigation'],
                    datasets: [{
                        label: 'Success Rate (%)',
                        data: [97.2, 100, 97.5, 96.5],
                        backgroundColor: [
                            'rgba(76, 175, 80, 0.8)',
                            'rgba(79, 195, 247, 0.8)',
                            'rgba(156, 39, 176, 0.8)',
                            'rgba(255, 152, 0, 0.8)'
                        ],
                        borderColor: [
                            '#4caf50',
                            '#4fc3f7',
                            '#9c27b0',
                            '#ff9800'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(26, 35, 50, 0.95)',
                            titleColor: '#4fc3f7',
                            bodyColor: '#e0e6ed',
                            callbacks: {
                                label: function(context) {
                                    return `Success Rate: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { 
                                color: '#a0aec0',
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#a0aec0' }
                        }
                    }
                }
            });
        }

        function initSignalTypeChart() {
            const ctx = document.getElementById('signalTypeChart').getContext('2d');
            
            charts.signalType = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['MC01_STRUCTURAL', 'MC02_QUANTITATIVE', 'MC03_NORMATIVE', 
                             'MC05_FINANCIAL', 'MC07_TEMPORAL', 'Others'],
                    datasets: [{
                        data: [245, 198, 176, 215, 189, 224],
                        backgroundColor: [
                            'rgba(79, 195, 247, 0.8)',
                            'rgba(76, 175, 80, 0.8)',
                            'rgba(156, 39, 176, 0.8)',
                            'rgba(255, 152, 0, 0.8)',
                            'rgba(33, 150, 243, 0.8)',
                            'rgba(158, 158, 158, 0.8)'
                        ],
                        borderColor: '#0a0e27',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#e0e6ed',
                                padding: 15,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 35, 50, 0.95)',
                            titleColor: '#4fc3f7',
                            bodyColor: '#e0e6ed',
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function initConsumerThroughputChart() {
            const ctx = document.getElementById('consumerThroughputChart').getContext('2d');
            
            const consumers = ['P01_Extract', 'P02_Enrich', 'P02_Contract', 'P02_Execute', 
                             'P03_Validate', 'P04_Micro', 'P05_Meso', 'P06_Macro'];
            const throughput = [156, 145, 132, 128, 121, 95, 78, 62];
            
            charts.consumerThroughput = new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: consumers,
                    datasets: [{
                        label: 'Signals/min',
                        data: throughput,
                        backgroundColor: 'rgba(79, 195, 247, 0.8)',
                        borderColor: '#4fc3f7',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(26, 35, 50, 0.95)',
                            titleColor: '#4fc3f7',
                            bodyColor: '#e0e6ed'
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#a0aec0' }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#a0aec0' }
                        }
                    }
                }
            });
        }

        function initLatencyChart() {
            const ctx = document.getElementById('latencyChart').getContext('2d');
            
            // Histogram data for latency distribution
            const latencyBuckets = ['0-20ms', '20-40ms', '40-60ms', '60-80ms', '80-100ms', '100ms+'];
            const frequencies = [245, 432, 318, 156, 78, 18];
            
            charts.latency = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: latencyBuckets,
                    datasets: [{
                        label: 'Signal Count',
                        data: frequencies,
                        backgroundColor: 'rgba(156, 39, 176, 0.8)',
                        borderColor: '#9c27b0',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(26, 35, 50, 0.95)',
                            titleColor: '#4fc3f7',
                            bodyColor: '#e0e6ed'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#a0aec0' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#a0aec0' }
                        }
                    }
                }
            });
        }

        function initErrorTypesChart() {
            const ctx = document.getElementById('errorTypesChart').getContext('2d');
            
            charts.errorTypes = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['NO_CONSUMER', 'TIMEOUT', 'VALIDATION_FAILED', 'GATE_REJECTED', 'SYSTEM_ERROR'],
                    datasets: [{
                        data: [28, 15, 12, 8, 1],
                        backgroundColor: [
                            'rgba(244, 67, 54, 0.8)',
                            'rgba(255, 152, 0, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(156, 39, 176, 0.8)',
                            'rgba(158, 158, 158, 0.8)'
                        ],
                        borderColor: '#0a0e27',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e0e6ed',
                                padding: 10,
                                font: { size: 10 }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 35, 50, 0.95)',
                            titleColor: '#4fc3f7',
                            bodyColor: '#e0e6ed'
                        }
                    }
                }
            });
        }

        function initDLQChart() {
            const ctx = document.getElementById('dlqChart').getContext('2d');
            
            // Time series for dead letter queue
            const now = new Date();
            const labels = [];
            const dlqData = [];
            
            for (let i = 24; i >= 0; i--) {
                const time = new Date(now - i * 3600000); // 1 hour intervals
                labels.push(time);
                dlqData.push(Math.floor(Math.random() * 10 + 2));
            }
            
            charts.dlq = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Dead Letters',
                        data: dlqData,
                        borderColor: config.chartColors.error,
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(26, 35, 50, 0.95)',
                            titleColor: '#4fc3f7',
                            bodyColor: '#e0e6ed'
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'HH:mm'
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#a0aec0' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#a0aec0' }
                        }
                    }
                }
            });
        }

        function initPhaseChart() {
            const ctx = document.getElementById('phaseChart').getContext('2d');
            
            const phases = ['P00', 'P01', 'P02', 'P03', 'P04', 'P05', 'P06', 'P07', 'P08', 'P09'];
            const signalCounts = [245, 232, 218, 195, 178, 156, 142, 128, 115, 98];
            
            charts.phase = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: phases,
                    datasets: [{
                        label: 'Signals Processed',
                        data: signalCounts,
                        backgroundColor: 'rgba(0, 188, 212, 0.8)',
                        borderColor: '#00bcd4',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(26, 35, 50, 0.95)',
                            titleColor: '#4fc3f7',
                            bodyColor: '#e0e6ed'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#a0aec0' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#a0aec0' }
                        }
                    }
                }
            });
        }

        // ============================================================
        // GATE MATRIX
        // ============================================================
        
        function initializeGateMatrix() {
            const gates = [
                { number: '1', name: 'Scope Alignment', percentage: 97.2, passed: 1247, total: 1283 },
                { number: '2', name: 'Value Add', percentage: 100, passed: 1283, total: 1283 },
                { number: '3', name: 'Capability Match', percentage: 97.5, passed: 1251, total: 1283 },
                { number: '4', name: 'Irrigation Channel', percentage: 96.5, passed: 1238, total: 1283 }
            ];
            
            const container = document.getElementById('gateMatrix');
            container.innerHTML = gates.map(gate => `
                <div class="gate-card">
                    <div class="gate-number">Gate ${gate.number}</div>
                    <div class="gate-name">${gate.name}</div>
                    <div class="gate-percentage">${gate.percentage}%</div>
                    <div style="font-size: 0.75rem; color: #a0aec0; margin-top: 0.5rem;">
                        ${gate.passed}/${gate.total} signals
                    </div>
                </div>
            `).join('');
        }

        // ============================================================
        // CONSUMER GRID
        // ============================================================
        
        function initializeConsumerGrid() {
            const consumers = [
                { name: 'phase_00_bootstrap', status: 'active', throughput: 156, queue: 12 },
                { name: 'phase_00_providers', status: 'active', throughput: 142, queue: 8 },
                { name: 'phase_01_extraction', status: 'processing', throughput: 145, queue: 24 },
                { name: 'phase_01_enrichment', status: 'processing', throughput: 132, queue: 18 },
                { name: 'phase_02_enrichment', status: 'active', throughput: 128, queue: 15 },
                { name: 'phase_02_contract', status: 'active', throughput: 121, queue: 9 },
                { name: 'phase_02_evidence', status: 'active', throughput: 118, queue: 22 },
                { name: 'phase_02_executor', status: 'processing', throughput: 112, queue: 31 },
                { name: 'phase_03_validation', status: 'active', throughput: 95, queue: 6 },
                { name: 'phase_03_scoring', status: 'active', throughput: 89, queue: 4 },
                { name: 'phase_04_micro', status: 'waiting', throughput: 78, queue: 45 },
                { name: 'phase_05_meso', status: 'waiting', throughput: 62, queue: 38 },
                { name: 'phase_06_macro', status: 'waiting', throughput: 54, queue: 29 },
                { name: 'phase_07_meso_agg', status: 'waiting', throughput: 48, queue: 21 },
                { name: 'phase_08_macro_agg', status: 'waiting', throughput: 42, queue: 18 },
                { name: 'phase_09_report', status: 'waiting', throughput: 35, queue: 12 },
                { name: 'phase_09_export', status: 'waiting', throughput: 28, queue: 8 }
            ];
            
            const container = document.getElementById('consumerGrid');
            container.innerHTML = consumers.map(consumer => `
                <div class="consumer-card ${consumer.status}">
                    <div class="consumer-name">${consumer.name}</div>
                    <div class="consumer-stats">
                        <span>${consumer.throughput}/min</span>
                        <span>Q: ${consumer.queue}</span>
                    </div>
                </div>
            `).join('');
        }

        // ============================================================
        // FLOW DIAGRAM (D3.js)
        // ============================================================
        
        function initializeFlowDiagram() {
            const container = document.getElementById('flowDiagram');
            const width = container.clientWidth;
            const height = 400;
            
            const svg = d3.select('#flowDiagram')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // Define nodes (phases)
            const nodes = [
                { id: 'P00', name: 'Assembly', x: 50, y: 200, consumers: 2 },
                { id: 'P01', name: 'Extraction', x: 180, y: 200, consumers: 2 },
                { id: 'P02', name: 'Enrichment', x: 310, y: 200, consumers: 4 },
                { id: 'P03', name: 'Validation', x: 440, y: 200, consumers: 2 },
                { id: 'P04', name: 'Micro', x: 570, y: 100, consumers: 1 },
                { id: 'P05', name: 'Meso', x: 570, y: 200, consumers: 1 },
                { id: 'P06', name: 'Macro', x: 570, y: 300, consumers: 1 },
                { id: 'P07', name: 'Meso Agg', x: 700, y: 150, consumers: 1 },
                { id: 'P08', name: 'Macro Agg', x: 700, y: 250, consumers: 1 },
                { id: 'P09', name: 'Report', x: 830, y: 200, consumers: 1 }
            ];
            
            // Define links
            const links = [
                { source: 0, target: 1 },
                { source: 1, target: 2 },
                { source: 2, target: 3 },
                { source: 3, target: 4 },
                { source: 3, target: 5 },
                { source: 3, target: 6 },
                { source: 4, target: 7 },
                { source: 5, target: 7 },
                { source: 6, target: 8 },
                { source: 7, target: 9 },
                { source: 8, target: 9 }
            ];
            
            // Draw links
            svg.selectAll('.flow-link')
                .data(links)
                .enter()
                .append('line')
                .attr('class', 'flow-link')
                .attr('x1', d => nodes[d.source].x + 40)
                .attr('y1', d => nodes[d.source].y + 20)
                .attr('x2', d => nodes[d.target].x)
                .attr('y2', d => nodes[d.target].y + 20)
                .attr('stroke', '#4fc3f7')
                .attr('stroke-width', 2)
                .attr('stroke-dasharray', '5,5');
            
            // Draw nodes
            const nodeGroups = svg.selectAll('.flow-node')
                .data(nodes)
                .enter()
                .append('g')
                .attr('class', 'flow-node')
                .attr('transform', d => `translate(${d.x},${d.y})`);
            
            nodeGroups.append('rect')
                .attr('width', 80)
                .attr('height', 40)
                .attr('rx', 8)
                .attr('fill', '#2a3544')
                .attr('stroke', '#4fc3f7')
                .attr('stroke-width', 2);
            
            nodeGroups.append('text')
                .attr('x', 40)
                .attr('y', 15)
                .attr('text-anchor', 'middle')
                .attr('fill', '#4fc3f7')
                .attr('font-size', '11px')
                .attr('font-weight', 'bold')
                .text(d => d.id);
            
            nodeGroups.append('text')
                .attr('x', 40)
                .attr('y', 30)
                .attr('text-anchor', 'middle')
                .attr('fill', '#a0aec0')
                .attr('font-size', '9px')
                .text(d => `[${d.consumers}]`);
            
            // Add hover effects
            nodeGroups.on('mouseover', function() {
                d3.select(this).select('rect')
                    .transition()
                    .duration(200)
                    .attr('fill', '#3a4554');
            });
            
            nodeGroups.on('mouseout', function() {
                d3.select(this).select('rect')
                    .transition()
                    .duration(200)
                    .attr('fill', '#2a3544');
            });
        }

        // ============================================================
        // DATA UPDATE FUNCTIONS
        // ============================================================
        
        function updateDashboardWithMetrics(data) {
            // Update charts with real data
            if (data.throughput && charts.throughput) {
                addThroughputData(data.throughput);
            }
            
            if (data.gates && charts.gateSuccess) {
                updateGateChart(data.gates);
            }
            
            if (data.consumers && charts.consumerThroughput) {
                updateConsumerChart(data.consumers);
            }
        }

        function addThroughputData(throughputData) {
            const chart = charts.throughput;
            const now = new Date();
            
            // Add new data point
            chart.data.labels.push(now);
            chart.data.datasets[0].data.push(throughputData.dispatched || 0);
            chart.data.datasets[1].data.push(throughputData.delivered || 0);
            
            // Remove old data if exceeds max points
            if (chart.data.labels.length > config.maxDataPoints) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
                chart.data.datasets[1].data.shift();
            }
            
            chart.update('none'); // Update without animation for smooth real-time
        }

        function updateGateChart(gatesData) {
            if (charts.gateSuccess && gatesData.length >= 4) {
                charts.gateSuccess.data.datasets[0].data = gatesData.map(g => g.successRate);
                charts.gateSuccess.update();
            }
        }

        function updateConsumerChart(consumersData) {
            if (charts.consumerThroughput) {
                const throughput = consumersData.map(c => c.throughput || 0);
                charts.consumerThroughput.data.datasets[0].data = throughput;
                charts.consumerThroughput.update();
            }
        }

        function updateFlowDiagram(progressData) {
            // Update flow diagram based on pipeline progress
            // This would animate the current active phase
            console.log('[Flow] Update with progress:', progressData);
        }

        // ============================================================
        // CONTROL FUNCTIONS
        // ============================================================
        
        function setTimeRange(range) {
            currentTimeRange = range;
            
            // Update button states
            document.querySelectorAll('.panel-controls .control-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Reload throughput chart with new time range
            console.log('[Controls] Time range set to:', range);
            // TODO: Fetch data for new time range
        }

        function refreshDashboard() {
            console.log('[Dashboard] Manual refresh triggered');
            socket.emit('request_sisas_update');
            
            // Visual feedback
            const btn = event.target;
            btn.textContent = '‚ü≥ Refreshing...';
            setTimeout(() => {
                btn.textContent = 'üîÑ Refresh';
            }, 1000);
        }

        function resetZoom() {
            console.log('[Flow] Reset zoom');
            // TODO: Reset D3 zoom/pan
        }

        function toggleAnimation() {
            animationEnabled = !animationEnabled;
            console.log('[Flow] Animation:', animationEnabled ? 'enabled' : 'disabled');
            
            // Update button text
            event.target.textContent = animationEnabled ? 'Pause Animation' : 'Resume Animation';
        }

        // ============================================================
        // AUTO-REFRESH
        // ============================================================
        
        function startAutoRefresh() {
            setInterval(() => {
                if (socket && socket.connected) {
                    socket.emit('request_sisas_update');
                }
            }, config.updateInterval);
            
            console.log('[Dashboard] Auto-refresh started (interval:', config.updateInterval, 'ms)');
        }

        // ============================================================
        // UTILITY FUNCTIONS
        // ============================================================
        
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function formatPercentage(value) {
            return (value * 100).toFixed(1) + '%';
        }

        function formatLatency(ms) {
            return ms < 1000 ? ms + 'ms' : (ms / 1000).toFixed(2) + 's';
        }

        console.log('[SISAS Dashboard] Initialization complete');
    </script>
</body>
</html>
