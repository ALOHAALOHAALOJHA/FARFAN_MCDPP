# ============================================================================
# Stage Contract Template
# ============================================================================
# F.A.R.F.A.N Pipeline - Design by Contract
# ============================================================================

stage: TEMPLATE_STAGE_NAME

contract:
  # --------------------------------------------------------------------------
  # Inputs Specification
  # --------------------------------------------------------------------------
  inputs:
    required:
      - name: input_name
        schema: 
          type: object
          properties:
            field1: { type: string }
            field2: { type: integer }
        source: "upstream_stage | file | api"
        
    optional:
      - name: optional_input
        schema: { type: string }
        default: null

  # --------------------------------------------------------------------------
  # Outputs Specification  
  # --------------------------------------------------------------------------
  outputs:
    guaranteed:
      - name: output_name
        schema:
          type: object
          properties:
            result: { type: any }
            metadata: { type: object }
        destination: "downstream_stage | file | api"

  # --------------------------------------------------------------------------
  # Invariants (must hold before, during, and after execution)
  # --------------------------------------------------------------------------
  invariants:
    - "output.count >= input.count"
    - "checksum(output) is not null"
    - "execution_time <= sla.max_runtime_minutes * 60"

  # --------------------------------------------------------------------------
  # Idempotency Configuration
  # --------------------------------------------------------------------------
  idempotency:
    key: "${municipality_id}-${date}-${stage_name}"
    strategy: "skip_if_exists | overwrite | versioned"
    
  # --------------------------------------------------------------------------
  # Retry Policy
  # --------------------------------------------------------------------------
  retry_policy:
    max_attempts: 3
    backoff_strategy: "exponential"
    backoff_base_seconds: 30
    backoff_max_seconds: 300
    retryable_errors:
      - "TIMEOUT"
      - "TRANSIENT_NETWORK_ERROR"
    non_retryable_errors:
      - "VALIDATION_ERROR"
      - "CONTRACT_VIOLATION"

  # --------------------------------------------------------------------------
  # Timeout
  # --------------------------------------------------------------------------
  timeout_seconds: 1800

  # --------------------------------------------------------------------------
  # Compensating Action (rollback on failure)
  # --------------------------------------------------------------------------
  compensating_action:
    description: "Delete partial artifacts and reset state"
    steps:
      - action: "delete_file"
        target: "artifacts/${stage_name}/*"
      - action: "log_failure"
        level: "ERROR"

# ============================================================================
# Observability Configuration
# ============================================================================
observability:
  metrics:
    - name: "stage_duration_seconds"
      type: histogram
      labels: [stage_name, municipality_id]
    - name: "stage_success_total"
      type: counter
      labels: [stage_name]
    - name: "stage_failure_total"
      type: counter  
      labels: [stage_name, error_type]
      
  logs:
    correlation_id: true
    structured: true
    fields:
      - run_id
      - stage_name
      - timestamp
      - level
      - message
      
  traces:
    enabled: true
    span_name: "${stage_name}"
    attributes:
      - municipality_id
      - input_count
      - output_count
