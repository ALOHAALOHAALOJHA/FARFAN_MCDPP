name: CQVR Contract Quality Validation

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'src/farfan_pipeline/phases/Phase_two/json_files_phase_two/executor_contracts/specialized/*.json'
      - 'src/farfan_pipeline/phases/Phase_two/json_files_phase_two/executor_contracts/cqvr_validator.py'
      - 'scripts/cqvr_batch_evaluator.py'
  
  pull_request:
    paths:
      - 'src/farfan_pipeline/phases/Phase_two/json_files_phase_two/executor_contracts/specialized/*.json'
      - 'src/farfan_pipeline/phases/Phase_two/json_files_phase_two/executor_contracts/cqvr_validator.py'
      - 'scripts/cqvr_batch_evaluator.py'
  
  workflow_dispatch:
    inputs:
      contracts:
        description: 'Contract files to evaluate (comma-separated, leave empty for all)'
        required: false
        default: ''
      threshold:
        description: 'Minimum quality threshold (0-100)'
        required: false
        default: '40'
  
  schedule:
    - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  detect-changes:
    name: Detect Changed Contracts
    runs-on: ubuntu-latest
    outputs:
      contracts: ${{ steps.detect.outputs.contracts }}
      all-contracts: ${{ steps.detect.outputs.all-contracts }}
      has-changes: ${{ steps.detect.outputs.has-changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Detect changed contracts
        id: detect
        run: |
          CONTRACTS_DIR="src/farfan_pipeline/phases/Phase_two/json_files_phase_two/executor_contracts/specialized"
          
          # For PR or push, detect changed contracts
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "Detecting changed contracts in PR..."
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep "^${CONTRACTS_DIR}/.*\.json$" || true)
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            echo "Detecting changed contracts in push..."
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }}...${{ github.event.after }} | grep "^${CONTRACTS_DIR}/.*\.json$" || true)
          else
            echo "No change detection needed for this event type"
            CHANGED_FILES=""
          fi
          
          # Extract filenames
          if [[ -n "$CHANGED_FILES" ]]; then
            CONTRACTS=$(echo "$CHANGED_FILES" | xargs -n1 basename | tr '\n' ' ' | sed 's/ $//')
            echo "contracts=$CONTRACTS" >> $GITHUB_OUTPUT
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "Changed contracts: $CONTRACTS"
          else
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "No contract changes detected"
          fi
          
          # Get all contracts for scheduled runs or manual dispatch
          ALL_CONTRACTS=$(ls $CONTRACTS_DIR/*.json | xargs -n1 basename | tr '\n' ' ' | sed 's/ $//')
          echo "all-contracts=$ALL_CONTRACTS" >> $GITHUB_OUTPUT
          echo "Total contracts available: $(echo $ALL_CONTRACTS | wc -w)"

  evaluate-contracts:
    name: Evaluate Contract Quality
    runs-on: ubuntu-latest
    needs: detect-changes
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
      
      - name: Determine contracts to evaluate
        id: contracts
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "mode=full" >> $GITHUB_OUTPUT
            echo "contracts=${{ needs.detect-changes.outputs.all-contracts }}" >> $GITHUB_OUTPUT
            echo "Running scheduled full evaluation"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ -n "${{ github.event.inputs.contracts }}" ]]; then
              CONTRACTS=$(echo "${{ github.event.inputs.contracts }}" | tr ',' ' ')
              echo "mode=manual" >> $GITHUB_OUTPUT
              echo "contracts=$CONTRACTS" >> $GITHUB_OUTPUT
              echo "Running manual evaluation on: $CONTRACTS"
            else
              echo "mode=full" >> $GITHUB_OUTPUT
              echo "contracts=${{ needs.detect-changes.outputs.all-contracts }}" >> $GITHUB_OUTPUT
              echo "Running manual full evaluation"
            fi
          elif [[ "${{ needs.detect-changes.outputs.has-changes }}" == "true" ]]; then
            echo "mode=incremental" >> $GITHUB_OUTPUT
            echo "contracts=${{ needs.detect-changes.outputs.contracts }}" >> $GITHUB_OUTPUT
            echo "Running incremental evaluation on changed contracts"
          else
            echo "mode=skip" >> $GITHUB_OUTPUT
            echo "No contracts to evaluate"
          fi
      
      - name: Run CQVR evaluation
        if: steps.contracts.outputs.mode != 'skip'
        id: evaluate
        run: |
          THRESHOLD="${{ github.event.inputs.threshold || '40' }}"
          CONTRACTS_DIR="src/farfan_pipeline/phases/Phase_two/json_files_phase_two/executor_contracts/specialized"
          OUTPUT_DIR="cqvr_reports"
          
          echo "Evaluating contracts with threshold: $THRESHOLD"
          
          if [[ "${{ steps.contracts.outputs.mode }}" == "full" ]]; then
            python scripts/cqvr_batch_evaluator.py \
              --contracts-dir "$CONTRACTS_DIR" \
              --output-dir "$OUTPUT_DIR" \
              --threshold "$THRESHOLD" \
              --fail-below-threshold
          else
            python scripts/cqvr_batch_evaluator.py \
              --contracts-dir "$CONTRACTS_DIR" \
              --output-dir "$OUTPUT_DIR" \
              --threshold "$THRESHOLD" \
              --contracts ${{ steps.contracts.outputs.contracts }} \
              --fail-below-threshold
          fi
        continue-on-error: true
      
      - name: Check evaluation result
        id: check
        run: |
          if [[ -f "cqvr_reports/cqvr_evaluation_report.json" ]]; then
            FAILED=$(jq -r '.failed' cqvr_reports/cqvr_evaluation_report.json)
            PASSED=$(jq -r '.passed' cqvr_reports/cqvr_evaluation_report.json)
            TOTAL=$(jq -r '.total_contracts' cqvr_reports/cqvr_evaluation_report.json)
            
            echo "failed=$FAILED" >> $GITHUB_OUTPUT
            echo "passed=$PASSED" >> $GITHUB_OUTPUT
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            
            if [[ "$FAILED" -gt 0 ]]; then
              echo "result=failure" >> $GITHUB_OUTPUT
              echo "âŒ Evaluation FAILED: $FAILED/$TOTAL contracts below threshold"
            else
              echo "result=success" >> $GITHUB_OUTPUT
              echo "âœ… Evaluation PASSED: All $TOTAL contracts meet quality threshold"
            fi
          else
            echo "result=error" >> $GITHUB_OUTPUT
            echo "âŒ Evaluation report not found"
          fi
      
      - name: Upload evaluation reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cqvr-evaluation-reports-${{ github.run_number }}
          path: |
            cqvr_reports/cqvr_evaluation_report.json
            cqvr_reports/cqvr_evaluation_report.md
          retention-days: 90
      
      - name: Upload dashboard
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cqvr-dashboard-${{ github.run_number }}
          path: cqvr_reports/cqvr_dashboard.html
          retention-days: 90
      
      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let comment = '## ðŸ“Š CQVR Contract Quality Evaluation\n\n';
            
            if (fs.existsSync('cqvr_reports/cqvr_evaluation_report.json')) {
              const report = JSON.parse(fs.readFileSync('cqvr_reports/cqvr_evaluation_report.json', 'utf8'));
              
              const passed = report.passed;
              const failed = report.failed;
              const total = report.total_contracts;
              const threshold = report.threshold;
              const passRate = (passed / total * 100).toFixed(1);
              
              const statusEmoji = failed === 0 ? 'âœ…' : 'âŒ';
              
              comment += `${statusEmoji} **Status**: ${passed}/${total} contracts passed (threshold: ${threshold}/100)\n\n`;
              comment += `| Metric | Value |\n`;
              comment += `|--------|-------|\n`;
              comment += `| **Pass Rate** | ${passRate}% |\n`;
              comment += `| **Passed** | ${passed} |\n`;
              comment += `| **Failed** | ${failed} |\n\n`;
              
              if (report.results && report.results.length > 0) {
                comment += `### Contract Results\n\n`;
                comment += `| Contract | Score | Status | Triage |\n`;
                comment += `|----------|-------|--------|--------|\n`;
                
                for (const result of report.results) {
                  const status = result.score >= threshold ? 'âœ…' : 'âŒ';
                  comment += `| ${result.contract_name} | ${result.score}/100 | ${status} | ${result.triage_decision} |\n`;
                }
              }
              
              if (failed > 0) {
                comment += `\n### âŒ Quality Gate: BLOCKED\n\n`;
                comment += `The following contracts are below the quality threshold of ${threshold}/100:\n\n`;
                for (const contract of report.failed_contracts) {
                  comment += `- ${contract}\n`;
                }
                comment += `\n**Action Required**: Improve contract quality before merging.\n`;
              } else {
                comment += `\n### âœ… Quality Gate: PASSED\n\n`;
                comment += `All contracts meet the quality threshold. Ready to merge!\n`;
              }
              
              comment += `\n---\n`;
              comment += `ðŸ“¥ [Download detailed report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
              
            } else {
              comment += 'âŒ Evaluation failed to generate report. Check workflow logs.\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Block merge if quality below threshold
        if: github.event_name == 'pull_request' && steps.check.outputs.result == 'failure'
        run: |
          echo "âŒ QUALITY GATE FAILED"
          echo "Failed contracts: ${{ steps.check.outputs.failed }}/${{ steps.check.outputs.total }}"
          echo "Quality threshold not met. Blocking merge."
          exit 1
      
      - name: Update commit status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const state = '${{ steps.check.outputs.result }}' === 'success' ? 'success' : 'failure';
            const description = '${{ steps.check.outputs.result }}' === 'success' 
              ? 'All contracts meet quality threshold'
              : '${{ steps.check.outputs.failed }} contracts below threshold';
            
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: state,
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: description,
              context: 'CQVR Quality Gate'
            });
      
      - name: Fail workflow if quality gate failed
        if: steps.check.outputs.result == 'failure'
        run: exit 1

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: evaluate-contracts
    if: failure() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `[CQVR] Scheduled contract quality evaluation failed`;
            const body = `
            # âš ï¸ CQVR Evaluation Failure
            
            The scheduled CQVR contract quality evaluation has failed.
            
            **Details:**
            - **Run ID**: ${{ github.run_id }}
            - **Timestamp**: ${new Date().toISOString()}
            - **Event**: ${{ github.event_name }}
            
            **Action Required:**
            Review the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
            
            ---
            *This issue was automatically created by the CQVR CI/CD pipeline*
            `;
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'cqvr,automated'
            });
            
            const existingIssue = issues.data.find(issue => issue.title.includes('[CQVR]'));
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['cqvr', 'automated', 'quality-gate']
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `Another failure occurred. See [run ${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).`
              });
            }
