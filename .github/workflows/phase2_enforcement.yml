name: Phase 2 Enforcement

on:
  push:
    paths:
      - 'src/farfan_pipeline/phases/Phase_02/**'
  pull_request:
    paths:
      - 'src/farfan_pipeline/phases/Phase_02/**'

env:
  PYTHON_VERSION: '3.12'
  PHASE2_RANDOM_SEED: 42

jobs:
  naming-enforcement:
    name: Naming Convention Enforcement
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate Phase 2 file names
        run: |
          # Check phase-root files match pattern
          for f in src/farfan_pipeline/phases/Phase_02/*.py; do
            basename=$(basename "$f")
            if [[ "$basename" != "__init__.py" ]] && [[ ! "$basename" =~ ^phase2_[a-z]_[a-z0-9_]+\.py$ ]]; then
              echo "NAMING_VIOLATION: $f"
              exit 1
            fi
          done
          echo "Phase-root naming: PASS"
      
      - name: Check for forbidden legacy files
        run: |
          FORBIDDEN=(
            "executors.py"
            "batch_executor.py"
            "batch_generate_all_configs.py"
          )
          for pattern in "${FORBIDDEN[@]}"; do
            if find . -name "$pattern" | grep -q .; then
              echo "LEGACY_ARTIFACT_FOUND: $pattern"
              exit 1
            fi
          done
          echo "Legacy artifact check: PASS"
      
      - name: Check for Phase 2 files outside canonical root
        run: |
          # Find phase2-related files outside canonical location
          find src -name "*phase2*" -o -name "*Phase2*" | \
            grep -v "src/farfan_pipeline/phases/Phase_02" && \
            { echo "PHASE2_FILE_OUTSIDE_CANONICAL"; exit 1; } || \
            echo "Canonical root check: PASS"

  schema-validation:
    name: Schema Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install jsonschema
      
      - name: Validate schemas are valid JSON Schema
        run: |
          python -c "
          import json
          import jsonschema
          from pathlib import Path
          
          schemas_dir = Path('src/farfan_pipeline/phases/Phase_02/schemas')
          for schema_file in schemas_dir.glob('*.schema.json'):
              with open(schema_file) as f:
                  schema = json.load(f)
              jsonschema.Draft202012Validator.check_schema(schema)
              print(f'VALID: {schema_file.name}')
          "

  forbidden-imports:
    name: Forbidden Import Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Scan for forbidden imports
        run: |
          FORBIDDEN_IMPORTS=(
            "questionnaire_monolith"
            "from executors import"
            "import executors"
            "batch_executor"
          )
          
          for pattern in "${FORBIDDEN_IMPORTS[@]}"; do
            if grep -r "$pattern" src/farfan_pipeline/phases/Phase_02 --include="*.py"; then
              echo "FORBIDDEN_IMPORT: $pattern"
              exit 1
            fi
          done
          echo "Forbidden import check: PASS"

  test-suite:
    name: Phase 2 Test Suite
    runs-on: ubuntu-latest
    needs: [naming-enforcement, schema-validation, forbidden-imports]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install pytest pytest-cov mypy jsonschema
          pip install -e .
      
      - name: Run mypy strict
        run: |
          mypy src/farfan_pipeline/phases/Phase_02 --strict --ignore-missing-imports
      
      - name: Run Phase 2 tests with fixed seed
        env:
          PHASE2_RANDOM_SEED: ${{ env.PHASE2_RANDOM_SEED }}
        run: |
          pytest src/farfan_pipeline/phases/Phase_02/tests/ -v --tb=short
      
      - name: Verify determinism (run tests twice)
        run: |
          pytest src/farfan_pipeline/phases/Phase_02/tests/test_phase2_carver_300_delivery.py -v
          pytest src/farfan_pipeline/phases/Phase_02/tests/test_phase2_carver_300_delivery.py -v

  certificate-check:
    name: Certificate Presence Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Verify 15 certificates exist
        run: |
          CERT_DIR="src/farfan_pipeline/phases/Phase_02/contracts/certificates"
          EXPECTED=15
          ACTUAL=$(ls -1 "$CERT_DIR"/CERTIFICATE_*.md 2>/dev/null | wc -l)
          
          if [ "$ACTUAL" -ne "$EXPECTED" ]; then
            echo "CERTIFICATE_COUNT_MISMATCH: expected=$EXPECTED, actual=$ACTUAL"
            exit 1
          fi
          echo "Certificate count: PASS ($ACTUAL/$EXPECTED)"
      
      - name: Verify certificate format
        run: |
          for cert in src/farfan_pipeline/phases/Phase_02/contracts/certificates/CERTIFICATE_*.md; do
            # Check required fields
            for field in "Status" "Effective Date" "Verification Method"; do
              if ! grep -q "$field" "$cert"; then
                echo "MISSING_FIELD: $cert lacks '$field'"
                exit 1
              fi
            done
            
            # Check Status is ACTIVE
            if ! grep -q "Status.*ACTIVE" "$cert"; then
              echo "INVALID_STATUS: $cert"
              exit 1
            fi
          done
          echo "Certificate format: PASS"
