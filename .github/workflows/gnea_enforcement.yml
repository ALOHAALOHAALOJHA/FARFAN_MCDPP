# GNEA Enforcement GitHub Actions Workflow
# Validates Global Nomenclature Enforcement Architecture compliance
# Document: FPN-GNEA-006
# Version: 1.0.0

name: GNEA Compliance Enforcement

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/farfan_pipeline/phases/**'
      - 'scripts/enforcement/**'
      - '.github/workflows/gnea_enforcement.yml'
      - 'GLOBAL_NAMING_POLICY.md'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/farfan_pipeline/phases/**'
      - 'scripts/enforcement/**'
      - '.github/workflows/gnea_enforcement.yml'
  workflow_dispatch:
    inputs:
      level:
        description: 'Enforcement level (L0, L1, L2, L3, L4)'
        required: false
        default: 'L2'
        type: choice
        options:
          - L0
          - L1
          - L2
          - L3
          - L4

env:
  PYTHON_VERSION: "3.11"
  ENFORCEMENT_LEVEL: ${{ github.event.inputs.level || 'L2' }}

jobs:
  gnea-validation:
    name: GNEA Compliance Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml toml
          # Install any additional dependencies needed for enforcement scripts

      - name: Run GNEA Enforcer
        id: gnea-enforcer
        run: |
          python scripts/enforcement/gnea_enforcer.py \
            --level ${{ env.ENFORCEMENT_LEVEL }} \
            --path . \
            --output artifacts/gnea_compliance_report.json \
            --fail-on-violations
        continue-on-error: true

      - name: Run Semantic Validator
        id: semantic-validator
        run: |
          python scripts/validation/semantic_validator.py \
            src/farfan_pipeline/phases
        continue-on-error: true

      - name: Run Hierarchy Guardian
        id: hierarchy-guardian
        run: |
          python scripts/enforcement/hierarchy_guardian.py \
            --path . \
            --max-depth 5 \
            --output artifacts/gnea_hierarchy_report.json
        continue-on-error: true

      - name: Create artifacts directory
        run: mkdir -p artifacts

      - name: Generate summary report
        if: always()
        run: |
          python scripts/enforcement/gnea_enforcer.py \
            --level ${{ env.ENFORCEMENT_LEVEL }} \
            --path . \
            --output artifacts/gnea_final_report.json

      - name: Upload compliance reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: gnea-compliance-reports
          path: |
            artifacts/gnea_compliance_report.json
            artifacts/gnea_hierarchy_report.json
            artifacts/gnea_final_report.json
          retention-days: 30

      - name: Extract compliance score
        id: compliance-score
        if: always()
        run: |
          if [ -f artifacts/gnea_final_report.json ]; then
            SCORE=$(python -c "import json; f=open('artifacts/gnea_final_report.json'); d=json.load(f); print(d.get('compliance_score', 0))")
            echo "score=$SCORE" >> $GITHUB_OUTPUT
            echo "Compliance Score: $SCORE%"
          else
            echo "score=0" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const score = '${{ steps.compliance-score.outputs.score }}';

            let comment = `## üîç GNEA Compliance Report\n\n`;
            comment += `**Enforcement Level:** ${{ env.ENFORCEMENT_LEVEL }}\n`;
            comment += `**Compliance Score:** ${score}%\n\n`;

            if (parseFloat(score) >= 99.5) {
              comment += `### ‚úÖ PASSED\n\nCompliance meets the 99.5% threshold.\n`;
            } else if (parseFloat(score) >= 95.0) {
              comment += `### ‚ö†Ô∏è WARNING\n\nCompliance is between 95% and 99.5%. Please review.\n`;
            } else {
              comment += `### ‚ùå FAILED\n\nCompliance is below 95%. Please fix violations before merging.\n`;
            }

            comment += `\n---\n\n`;
            comment += `üìä Full reports are available in the workflow artifacts.\n`;
            comment += `\n*Generated by GNEA Enforcement Workflow*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail on low compliance
        if: steps.compliance-score.outputs.score != ''
        run: |
          SCORE=${{ steps.compliance-score.outputs.score }}
          if (( $(echo "$SCORE < 95.0" | bc -l) )); then
            echo "::error::Compliance score ($SCORE%) is below 95% threshold"
            exit 1
          fi

  compliance-gate:
    name: Compliance Gate
    needs: gnea-validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Check compliance threshold
        id: check
        run: |
          SCORE=${{ needs.gnea-validation.outputs.compliance-score }}
          echo "Checking compliance score: $SCORE"

          if (( $(echo "$SCORE >= 99.5" | bc -l) )); then
            echo "status=pass" >> $GITHUB_OUTPUT
            echo "::notice::Compliance score ($SCORE%) meets 99.5% threshold"
          elif (( $(echo "$SCORE >= 95.0" | bc -l) )); then
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "::warning::Compliance score ($SCORE%) is between 95% and 99.5%"
          else
            echo "status=fail" >> $GITHUB_OUTPUT
            echo "::error::Compliance score ($SCORE%) is below 95% threshold"
            exit 1
          fi

      - name: Add status check
        if: always()
        run: |
          echo "GNEA Compliance: ${{ steps.check.outputs.status }}"

  # Optional: Auto-fix job for safe violations
  auto-fix:
    name: Auto-fix Safe Violations
    needs: gnea-validation
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/develop' &&
      contains(github.event.head_commit.message, '[gnea-auto-fix]')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run auto-fix engine
        run: |
          python scripts/enforcement/auto_fix_engine.py \
            --path . \
            --yes

      - name: Commit auto-fixes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git diff --quiet && git diff --staged --quiet || git commit -m "[gnea-auto-fix] Apply automatic GNEA fixes"
          git push
